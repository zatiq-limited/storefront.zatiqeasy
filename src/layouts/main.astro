---
/**
 * ========================================
 * MAIN LAYOUT
 * ========================================
 * 
 * Global layout with header, footer, and announcement bar
 * Dynamically loads from theme.json
 */

import '../styles/global.css';
import ComponentRenderer from '../components/ComponentRenderer';

interface Props {
	title?: string;
	description?: string;
	image?: string;
}

const { title, description, image } = Astro.props;

// Import API client (will be added below)
import { getTheme } from '../lib/api-client';

// Load theme data using API client
// Automatically handles API call with fallback
let themeData: any = null;
let designSystem: any = null;

try {
	// Use getTheme() which handles API call + fallback internally
	const themeResponse = await getTheme();
	themeData = themeResponse;
	console.log('[Layout] ✅ Theme loaded successfully');
} catch (error) {
	console.error('[Layout] ❌ Failed to load theme:', error);
}

// Load design system from theme_init.json
try {
	const themeInit = await import('../data/api-responses/theme_init.json');
	designSystem = themeInit.default?.data?.theme?.design || themeInit.data?.theme?.design;
} catch (e) {
	console.log('[Layout] Using default design system');
}

// Get global settings and sections from theme
const globalSettings = themeData?.globalSettings || null;
const announcement = themeData?.globalSections?.announcement || null;
const header = themeData?.globalSections?.header || null;
const announcementAfterHeader = themeData?.globalSections?.announcementAfterHeader || null;
const footer = themeData?.globalSections?.footer || null;

// SEO defaults
const siteTitle = title || 'Demo Fashion Store';
const siteDescription = description || 'Shop the latest fashion trends';
const ogImage = image || '';
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		
		<!-- SEO Meta Tags -->
		<title>{siteTitle}</title>
		<meta name="description" content={siteDescription} />
		
		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:title" content={siteTitle} />
		<meta property="og:description" content={siteDescription} />
		{ogImage && <meta property="og:image" content={ogImage} />}
		
		<!-- Twitter -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={siteTitle} />
		<meta name="twitter:description" content={siteDescription} />
		{ogImage && <meta name="twitter:image" content={ogImage} />}
		
		<!-- Design System CSS Variables -->
		<style is:inline define:vars={{ 
			primaryColor: designSystem?.colors?.primary || '#2563eb',
			secondaryColor: designSystem?.colors?.secondary || '#1f2937',
			accentColor: designSystem?.colors?.accent || '#f59e0b',
			backgroundColor: designSystem?.colors?.background || '#ffffff',
			textColor: designSystem?.colors?.text || '#111827',
			headingFont: designSystem?.fonts?.heading || 'Poppins, sans-serif',
			bodyFont: designSystem?.fonts?.body || 'Inter, system-ui, sans-serif'
		}}>
			:root {
				--color-primary: var(--primaryColor);
				--color-secondary: var(--secondaryColor);
				--color-accent: var(--accentColor);
				--color-background: var(--backgroundColor);
				--color-text: var(--textColor);
				--font-heading: var(--headingFont);
				--font-body: var(--bodyFont);
			}
			
			body {
				font-family: var(--font-body);
				color: var(--color-text);
				background-color: var(--color-background);
			}
			
			h1, h2, h3, h4, h5, h6 {
				font-family: var(--font-heading);
			}
		</style>
	</head>
	<body>
		<!-- Announcement Bar (Global) - Dynamic from theme.json -->
		{announcement?.enabled && (
			<ComponentRenderer
				type={announcement.type}
				{...announcement.settings}
				blocks={announcement.blocks}
				globalSettings={globalSettings}
				client:load
			/>
		)}

		<!-- Header/Navbar (Global) - Dynamic from theme.json -->
		{header?.enabled && (
			<ComponentRenderer
				type={header.type}
				{...header.settings}
				blocks={header.blocks}
				globalSettings={globalSettings}
				client:load
			/>
		)}

		<!-- Announcement Bar After Header (Global) - Dynamic from theme.json -->
		{announcementAfterHeader?.enabled && (
			<ComponentRenderer
				type={announcementAfterHeader.type}
				{...announcementAfterHeader.settings}
				blocks={announcementAfterHeader.blocks}
				globalSettings={globalSettings}
				client:load
			/>
		)}

		<!-- Main Content -->
		<div class="zatiq-main-content">
			<slot />
		</div>
		
		<!-- Footer (Global) - Dynamic from theme.json -->
		{footer?.enabled && (
			<ComponentRenderer
				type={footer.type}
				settings={footer.settings}
				blocks={footer.blocks}
				contact={footer.contact}
				paymentIcons={footer.paymentIcons}
				globalSettings={globalSettings}
				client:load
			/>
		)}
	</body>
</html>
