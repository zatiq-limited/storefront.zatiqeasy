---
/**
 * ========================================
 * PRODUCT DETAIL PAGE (DYNAMIC)
 * ========================================
 *
 * Single product page with dynamic sections from API
 * Sections: Breadcrumb, ProductDetail, CustomerReviews, RelatedProducts
 */

import Layout from '../../layouts/main.astro';
import ProductDetailsPageRenderer from '../../components/ProductDetailsPageRenderer';

// Enable server-side rendering for dynamic product pages
export const prerender = false;

// Get handle from URL
const { handle } = Astro.params;

// Fetch product from API
let product: any = null;
let theme: any = null;
let sections: any[] = [];

try {
	const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001';

	// Fetch product data
	const productResponse = await fetch(`${API_BASE_URL}/api/storefront/v1/products/${handle}`);
	const productResult = await productResponse.json();

	if (productResult.success && productResult.data?.product) {
		product = productResult.data.product;
		theme = product.theme || null;
	}

	// Fetch page sections config
	const sectionsResponse = await fetch(`${API_BASE_URL}/api/storefront/v1/page/product-details`);
	const sectionsResult = await sectionsResponse.json();

	if (sectionsResult.success && sectionsResult.data?.sections) {
		sections = sectionsResult.data.sections;
	}
} catch (error) {
	console.error('[Product Page] Failed to load product:', error);
}

if (!product) {
	return Astro.redirect('/404');
}

// Fallback sections if API doesn't return any
if (!sections || sections.length === 0) {
	sections = [
		{
			id: "product_breadcrumb",
			type: "product-breadcrumb-1",
			enabled: true,
			settings: {
				showHome: true,
				showCategory: true
			}
		},
		{
			id: "product_detail",
			type: "product-detail-1",
			enabled: true,
			settings: {
				showBrand: true,
				showSku: true,
				showRating: true,
				showStock: true,
				showVariants: true,
				showDescription: true,
				showSpecifications: true,
				showShipping: true,
				galleryPosition: "left",
				thumbnailPosition: "bottom"
			}
		},
		{
			id: "customer_reviews",
			type: "customer-reviews-1",
			enabled: true,
			settings: {
				title: "Customer Reviews",
				showRatingSummary: true,
				showReviewImages: true,
				columns: 3,
				limit: 6
			}
		},
		{
			id: "related_products",
			type: "related-products-1",
			enabled: true,
			settings: {
				title: "You May Also Like",
				columns: 4,
				cardStyle: "product-card-1",
				limit: 8
			}
		}
	];
}
---

<Layout
	title={theme?.page_title || `${product.name} | ZatiqEasy`}
	description={theme?.page_description || product.description || product.short_description}
	image={product.image_url}
>
	<ProductDetailsPageRenderer
		sections={sections}
		product={product}
		client:load
	/>
</Layout>

<style>
	/* Smooth scrolling */
	html {
		scroll-behavior: smooth;
	}

	/* Line clamp utilities */
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
