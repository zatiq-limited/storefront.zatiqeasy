---
/**
 * ========================================
 * PRODUCTS LISTING PAGE
 * ========================================
 *
 * Dynamic products page - sections from API, just like homepage
 *
 * Backend API Endpoint: GET /api/storefront/v1/page/products
 */

import Layout from '../layouts/main.astro';
import ProductsPageRenderer from '../components/ProductsPageRenderer';
import { getProductsPageData } from '../lib/api-client';

// Get query parameters for filtering
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1');
const category = url.searchParams.get('category') || '';
const sort = url.searchParams.get('sort') || 'featured';
const search = url.searchParams.get('search') || '';

// Fetch products page data from API (sections + products combined)
let pageData: any = null;
let sections: any[] = [];
let products: any[] = [];
let pagination: any = null;
let filters: any = { page: 1, category: null, search: null, sort: 'featured' };
let seo: any = {};

try {
  pageData = await getProductsPageData({ page, category, sort, search });

  if (pageData) {
    sections = pageData.sections || [];
    products = pageData.products || [];
    pagination = pageData.pagination || null;
    filters = pageData.filters || { page, category: category || null, search: search || null, sort };
    seo = pageData.seo || {};
  }
} catch (error) {
  console.error('[Products Page] Failed to load data:', error);
}

// Dynamic title based on search/category
const title = search
  ? `Search Results for "${search}"`
  : category
  ? `${category} Products`
  : seo?.title || 'All Products';
---

<Layout
  title={`${title} | ZatiqEasy`}
  description={seo?.description || "Shop our complete collection of premium fashion and lifestyle products"}
  image={seo?.og?.image}
>
  <main class="zatiq-products-page">
    <ProductsPageRenderer
      sections={sections}
      products={products}
      pagination={pagination}
      filters={filters}
      client:load
    />
  </main>
</Layout>
