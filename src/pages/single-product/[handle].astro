---
/**
 * ========================================
 * SINGLE PRODUCT PAGE (DYNAMIC)
 * ========================================
 *
 * Dynamic single product page with custom sections from API
 * Similar to product details page but with landing page sections
 *
 * Backend API Endpoints:
 * - GET /api/storefront/v1/page/single-product/:handle (page sections)
 * - GET /api/storefront/v1/products/:handle (product data)
 */

import Layout from '../../layouts/main.astro';
import SectionRenderer from '../../components/SectionRenderer';
import { getSingleProductPageData } from '../../lib/api-client';

// Enable server-side rendering for dynamic product pages
export const prerender = false;

// Get handle from URL
const { handle } = Astro.params;

// Validate handle
if (!handle) {
	return Astro.redirect('/404');
}

// Fetch page data and product data
let pageData: any = null;
let product: any = null;

try {
	const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001';

	// Fetch product data
	const productResponse = await fetch(`${API_BASE_URL}/api/storefront/v1/products/${handle}`);
	const productResult = await productResponse.json();

	if (productResult.success && productResult.data?.product) {
		product = productResult.data.product;
	}

	// Fetch page sections
	const singleProductPageData = await getSingleProductPageData(handle);
	pageData = singleProductPageData?.data || singleProductPageData || {};
} catch (error) {
	console.error('[Single Product Page] Failed to load data:', error);
}

// Redirect to 404 if product not found
if (!product) {
	return Astro.redirect('/404');
}

// Extract page data
const {
	template = 'single-product',
	sections = [],
	seo = {},
	payment_methods = [],
	delivery_options = [],
	currency = 'BDT'
} = pageData;

// Build SEO data - use product data as fallback
const pageTitle = seo?.title || product?.name || 'Product';
const pageDescription = seo?.description || product?.description || product?.short_description || '';
const pageImage = seo?.og?.image || product?.image_url || '';
---

<Layout
	title={pageTitle}
	description={pageDescription}
	image={pageImage}
>
	<main class="zatiq-single-product-page">
		<SectionRenderer
			sections={sections}
			product={product}
			paymentMethods={payment_methods}
			deliveryOptions={delivery_options}
			currency={currency}
			client:load
		/>
	</main>
</Layout>

<style>
	.zatiq-single-product-page {
		min-height: 100vh;
	}
</style>
