---
/**
 * ========================================
 * SINGLE PRODUCT LANDING PAGE (DYNAMIC)
 * ========================================
 *
 * Dynamic single product landing page with custom sections from API
 * The API returns complete page data including product info and sections
 *
 * Backend API Endpoint:
 * - GET /api/storefront/v1/page/single-product/:handle
 *   Returns: { template, product_handle, product, sections, seo }
 *
 * Route: /single-product/:productId
 * Example: /single-product/858755 loads single-product-858755.json from database
 */

import Layout from '../../layouts/main.astro';
import SectionRenderer from '../../components/SectionRenderer';
import { getSingleProductPageData } from '../../lib/api-client';

// Enable server-side rendering for dynamic product pages
export const prerender = false;

// Get handle from URL (product ID)
const { handle } = Astro.params;

// Validate handle
if (!handle) {
	return Astro.redirect('/404');
}

// Fetch single product landing page data (includes product + sections)
let pageData: any = null;
let product: any = null;

try {
	// Fetch complete page data from API
	// The API returns the stored landing page JSON which includes product data
	const singleProductPageData = await getSingleProductPageData(handle);
	pageData = singleProductPageData?.data || singleProductPageData || null;

	// Product data is included in the page data from theme builder export
	if (pageData) {
		product = pageData?.product || null;
	}

	// If product not in page data, try fetching separately as fallback
	if (!product && pageData) {
		const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001';
		const productResponse = await fetch(`${API_BASE_URL}/api/storefront/v1/products/${handle}`);
		const productResult = await productResponse.json();

		if (productResult.success && productResult.data?.product) {
			product = productResult.data.product;
		}
	}
} catch (error) {
	console.error('[Single Product Page] Failed to load data:', error);
}

// Redirect to 404 if no landing page exists for this product
if (!pageData || Object.keys(pageData).length === 0) {
	return Astro.redirect('/404');
}

// Extract page data
const {
	template = 'single-product',
	sections = [],
	seo = {},
	payment_methods = [],
	delivery_options = [],
	currency = 'BDT'
} = pageData;

// Build SEO data - use product data as fallback
const pageTitle = seo?.title || product?.name || 'Product';
const pageDescription = seo?.description || product?.description || product?.short_description || '';
const pageImage = seo?.og?.image || product?.image_url || '';
---

<Layout
	title={pageTitle}
	description={pageDescription}
	image={pageImage}
>
	<main class="zatiq-single-product-page">
		<SectionRenderer
			sections={sections}
			product={product}
			paymentMethods={payment_methods}
			deliveryOptions={delivery_options}
			currency={currency}
			client:load
		/>
	</main>
</Layout>

<style>
	.zatiq-single-product-page {
		min-height: 100vh;
	}
</style>
